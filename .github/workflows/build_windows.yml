name: Build Windows EXE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install requests
        pip install urllib3
        pip install pillow
        pip install numpy
        pip install opencv-python
        pip install ultralytics
        pip install psutil
        pip install mss
        pip install pyautogui
    
    - name: Build Windows EXE
      run: |
        pyinstaller --onefile --windowed --name Invariant --distpath dist --add-data "src;." --hidden-import tkinter --hidden-import tkinter.ttk --hidden-import tkinter.messagebox --hidden-import tkinter.filedialog --hidden-import Invariant_Cyberpunk invariant.py
    
    - name: Create Portable Package
      run: |
        mkdir Invariant_Portable
        copy dist\Invariant.exe Invariant_Portable\
        copy version.json Invariant_Portable\
        copy requirements.txt Invariant_Portable\
        copy docs\README.md Invariant_Portable\
        copy INSTALL_GUIDE.md Invariant_Portable\
        echo @echo off > Invariant_Portable\run.bat
        echo title Invariant - Master Project Hub >> Invariant_Portable\run.bat
        echo echo. >> Invariant_Portable\run.bat
        echo echo ======================================== >> Invariant_Portable\run.bat
        echo echo    Invariant - Master Project Hub >> Invariant_Portable\run.bat
        echo echo ======================================== >> Invariant_Portable\run.bat
        echo echo. >> Invariant_Portable\run.bat
        echo echo Starting Invariant... >> Invariant_Portable\run.bat
        echo echo. >> Invariant_Portable\run.bat
        echo Invariant.exe >> Invariant_Portable\run.bat
        echo pause >> Invariant_Portable\run.bat
    
    - name: Create Installer
      run: |
        echo @echo off > install.bat
        echo title Invariant Installer >> install.bat
        echo echo. >> install.bat
        echo echo ======================================== >> install.bat
        echo echo    Invariant - Master Project Hub >> install.bat
        echo echo ======================================== >> install.bat
        echo echo. >> install.bat
        echo echo Installing Invariant... >> install.bat
        echo echo. >> install.bat
        echo if not exist "C:\Invariant" mkdir "C:\Invariant" >> install.bat
        echo copy "Invariant.exe" "C:\Invariant\Invariant.exe" >> install.bat
        echo echo Creating desktop shortcut... >> install.bat
        echo powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%USERPROFILE%\Desktop\Invariant.lnk'); $Shortcut.TargetPath = 'C:\Invariant\Invariant.exe'; $Shortcut.WorkingDirectory = 'C:\Invariant'; $Shortcut.Save()" >> install.bat
        echo echo. >> install.bat
        echo echo âœ… Installation complete! >> install.bat
        echo echo. >> install.bat
        echo echo Invariant has been installed to C:\Invariant >> install.bat
        echo echo Desktop shortcut created >> install.bat
        echo echo. >> install.bat
        echo echo Press any key to launch Invariant... >> install.bat
        echo pause ^>nul >> install.bat
        echo start "" "C:\Invariant\Invariant.exe" >> install.bat
        echo exit >> install.bat
    
    - name: Upload Portable Package
      uses: actions/upload-artifact@v4
      with:
        name: Invariant_Portable_Windows
        path: Invariant_Portable/
    
    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: Invariant_Installer_Windows
        path: install.bat
    
    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Invariant_Portable/*
          install.bat
          INSTALL_GUIDE.md
        tag_name: v${{ github.run_number }}
        name: Invariant v${{ github.run_number }}
        body: |
          # Invariant v${{ github.run_number }}
          
          ## ğŸš€ Master Project Hub
          
          ëª¨ë“  í”„ë¡œì íŠ¸ë“¤ì„ í†µí•© ê´€ë¦¬í•˜ëŠ” ë©”ì¸ í—ˆë¸Œ ì‹œìŠ¤í…œ
          
          ### ì£¼ìš” ê¸°ëŠ¥
          - í†µí•© í”„ë¡œì íŠ¸ ê´€ë¦¬
          - GitHub ê¸°ë°˜ ìë™ ì—…ë°ì´íŠ¸  
          - ë²„ì „ ê´€ë¦¬ (ì•ˆì •í™”/ë² íƒ€)
          - ì›í´ë¦­ ì‹¤í–‰ ë° ì„¤ì¹˜
          - GUI ì¸í„°í˜ì´ìŠ¤
          
          ### ì„¤ì¹˜ ë°©ë²•
          1. `Invariant_Portable` í´ë”ë¥¼ ë‹¤ìš´ë¡œë“œ
          2. `Invariant.exe` ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹¤í–‰
          3. ë˜ëŠ” `install.bat` ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜
          
          ### ìš”êµ¬ì‚¬í•­
          - Windows 10/11 (64-bit)
          - Python ì„¤ì¹˜ ë¶ˆí•„ìš”
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}