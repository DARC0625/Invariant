name: Build Windows EXE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt5
        pip install requests
        pip install urllib3
        pip install pillow
        pip install numpy
        pip install opencv-python
        pip install ultralytics
        pip install psutil
        pip install mss
        pip install pyautogui
        pip install requests
    
    - name: Build Windows EXE
      run: |
        # src í´ë”ì˜ íŒŒì¼ë“¤ì„ ë£¨íŠ¸ë¡œ ë³µì‚¬
        Copy-Item src\Invariant_Dashboard.py .
        Copy-Item src\Project_Template.py .
        # PyInstallerë¡œ EXE ë¹Œë“œ
        pyinstaller --onefile --console --name Invariant --distpath dist --hidden-import PyQt5 --hidden-import PyQt5.QtCore --hidden-import PyQt5.QtWidgets --hidden-import PyQt5.QtGui --hidden-import psutil --hidden-import Invariant_Dashboard Invariant_Dashboard.py
    
    - name: Create Portable Package
      run: |
        if (Test-Path Invariant_Portable) { Remove-Item -Recurse -Force Invariant_Portable }
        New-Item -ItemType Directory -Name Invariant_Portable
        Copy-Item dist\Invariant.exe Invariant_Portable\
        Copy-Item debug_windows.py Invariant_Portable\
        Set-Content -Path Invariant_Portable\debug.bat -Value "@echo off`ntitle Invariant Debug`necho.`necho ========================================`necho    Invariant Debug Script`necho ========================================`necho.`necho Running debug script...`necho.`npython debug_windows.py`npause"
    
    
    - name: Upload Portable Package
      uses: actions/upload-artifact@v4
      with:
        name: Invariant_Portable_Windows
        path: Invariant_Portable/
    
    
    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Invariant_Portable/*
        tag_name: v${{ github.run_number }}
        name: Invariant v${{ github.run_number }}
        body: |
          # Invariant v${{ github.run_number }}
          
          ## ğŸš€ Master Project Hub
          
          ëª¨ë“  í”„ë¡œì íŠ¸ë“¤ì„ í†µí•© ê´€ë¦¬í•˜ëŠ” ë©”ì¸ í—ˆë¸Œ ì‹œìŠ¤í…œ
          
          ### ì£¼ìš” ê¸°ëŠ¥
          - í†µí•© í”„ë¡œì íŠ¸ ê´€ë¦¬
          - GitHub ê¸°ë°˜ ìë™ ì—…ë°ì´íŠ¸  
          - ë²„ì „ ê´€ë¦¬ (ì•ˆì •í™”/ë² íƒ€)
          - ì›í´ë¦­ ì‹¤í–‰ ë° ì„¤ì¹˜
          - GUI ì¸í„°í˜ì´ìŠ¤
          
          ### ì‹¤í–‰ ë°©ë²•
          1. `Invariant_Portable` í´ë”ë¥¼ ë‹¤ìš´ë¡œë“œ
          2. `Invariant.exe` ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹¤í–‰
          3. ë¬¸ì œê°€ ìˆìœ¼ë©´ `debug.bat` ì‹¤í–‰í•˜ì—¬ ì§„ë‹¨
          
          ### ìš”êµ¬ì‚¬í•­
          - Windows 10/11 (64-bit)
          - Python ì„¤ì¹˜ ë¶ˆí•„ìš”
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}