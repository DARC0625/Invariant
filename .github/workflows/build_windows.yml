name: Build Windows EXE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt5
        pip install requests
        pip install urllib3
        pip install pillow
        pip install numpy
        pip install opencv-python
        pip install ultralytics
        pip install psutil
        pip install mss
        pip install pyautogui
        pip install requests
    
    - name: Build Windows EXE
      run: |
        # src 폴더의 파일들을 루트로 복사
        Copy-Item src\Invariant_Dashboard.py .
        Copy-Item src\Project_Template.py .
        # PyInstaller로 EXE 빌드
        pyinstaller --onefile --console --name Invariant --distpath dist --hidden-import PyQt5 --hidden-import PyQt5.QtCore --hidden-import PyQt5.QtWidgets --hidden-import PyQt5.QtGui --hidden-import psutil --hidden-import Invariant_Dashboard Invariant_Dashboard.py
    
    - name: Create Portable Package
      run: |
        if (Test-Path Invariant_Portable) { Remove-Item -Recurse -Force Invariant_Portable }
        New-Item -ItemType Directory -Name Invariant_Portable
        Copy-Item dist\Invariant.exe Invariant_Portable\
        Copy-Item debug_windows.py Invariant_Portable\
        Set-Content -Path Invariant_Portable\debug.bat -Value "@echo off`ntitle Invariant Debug`necho.`necho ========================================`necho    Invariant Debug Script`necho ========================================`necho.`necho Running debug script...`necho.`npython debug_windows.py`npause"
    
    
    - name: Upload Portable Package
      uses: actions/upload-artifact@v4
      with:
        name: Invariant_Portable_Windows
        path: Invariant_Portable/
    
    
    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Invariant_Portable/*
        tag_name: v${{ github.run_number }}
        name: Invariant v${{ github.run_number }}
        body: |
          # Invariant v${{ github.run_number }}
          
          ## 🚀 Master Project Hub
          
          모든 프로젝트들을 통합 관리하는 메인 허브 시스템
          
          ### 주요 기능
          - 통합 프로젝트 관리
          - GitHub 기반 자동 업데이트  
          - 버전 관리 (안정화/베타)
          - 원클릭 실행 및 설치
          - GUI 인터페이스
          
          ### 실행 방법
          1. `Invariant_Portable` 폴더를 다운로드
          2. `Invariant.exe` 더블클릭으로 실행
          3. 문제가 있으면 `debug.bat` 실행하여 진단
          
          ### 요구사항
          - Windows 10/11 (64-bit)
          - Python 설치 불필요
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}