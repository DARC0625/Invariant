name: Build Windows Flutter App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
    
    - name: Install dependencies
      run: flutter pub get
      working-directory: ./invariant_flutter
    
    - name: Build Windows app
      run: flutter build windows --release
      working-directory: ./invariant_flutter
    
    - name: Create portable package
      run: |
        if (Test-Path "Invariant_Portable") { Remove-Item -Recurse -Force "Invariant_Portable" }
        New-Item -ItemType Directory -Name "Invariant_Portable"
        Copy-Item "invariant_flutter\build\windows\x64\runner\Release\*" "Invariant_Portable\" -Recurse
        Copy-Item "invariant_flutter\README.md" "Invariant_Portable\"
        
        # Create run.bat
        echo "@echo off" > "Invariant_Portable\run.bat"
        echo "title Invariant - Master Project Hub" >> "Invariant_Portable\run.bat"
        echo "echo." >> "Invariant_Portable\run.bat"
        echo "echo ========================================" >> "Invariant_Portable\run.bat"
        echo "echo    Invariant - Master Project Hub" >> "Invariant_Portable\run.bat"
        echo "echo ========================================" >> "Invariant_Portable\run.bat"
        echo "echo." >> "Invariant_Portable\run.bat"
        echo "echo Starting Invariant..." >> "Invariant_Portable\run.bat"
        echo "echo." >> "Invariant_Portable\run.bat"
        echo "invariant_flutter.exe" >> "Invariant_Portable\run.bat"
        echo "pause" >> "Invariant_Portable\run.bat"
        
        # Create version.json
        echo "{`"version`": `"1.2.0`", `"build_date`": `"$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`", `"description`": `"Cutting-edge Flutter UI with slide navigation and glassmorphism effects`", `"project_name`": `"Invariant`"}" > "Invariant_Portable\version.json"
    
    - name: Upload portable package
      uses: actions/upload-artifact@v4
      with:
        name: Invariant_Portable
        path: Invariant_Portable/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: Invariant_Portable/*
        tag_name: v1.2.0
        name: Invariant v1.2.0
        body: |
          # Invariant v1.2.0
          
          ## ğŸš€ Cutting-Edge Flutter UI
          
          ìµœì‹  Flutter ê¸°ìˆ ë¡œ êµ¬í˜„ëœ ë¯¸ë˜ì§€í–¥ì  UI ì‹œìŠ¤í…œ
          
          ### ì£¼ìš” ê¸°ëŠ¥
          - ìŠ¬ë¼ì´ë“œ ë„¤ë¹„ê²Œì´ì…˜ (ìŠ¤í¬ë¡¤ ëŒ€ì‹ )
          - ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ íš¨ê³¼
          - ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
          - ì»¤ìŠ¤í…€ í˜ì¸í„° ì°¨íŠ¸/ê²Œì´ì§€
          - Riverpod ìƒíƒœ ê´€ë¦¬
          - 3íŒ¨ë„ ë ˆì´ì•„ì›ƒ
          - ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
          
          ### ì„¤ì¹˜ ë°©ë²•
          1. `Invariant_Portable` í´ë”ë¥¼ ë‹¤ìš´ë¡œë“œ
          2. `run.bat` ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹¤í–‰
          3. ë˜ëŠ” `invariant_flutter.exe` ì§ì ‘ ì‹¤í–‰
          
          ### ìš”êµ¬ì‚¬í•­
          - Windows 10/11 (64-bit)
          - Visual C++ Redistributable
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}